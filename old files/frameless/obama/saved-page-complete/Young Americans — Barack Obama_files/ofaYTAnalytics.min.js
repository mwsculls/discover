(function(win){var YTAnalytics=YTAnalytics||{};YTAnalytics.players={};YTAnalytics.trackvideo=function(){var ofa=win.ofa,videoCategory="Youtube Tracking",tag,firstScriptTag,OFAlog,playPoll,onPlayerStateChange,onPlayerReady,onPlayerError,onYouTubePlayerAPIReady,pollPlayer,lastNum,pausePolling,videoComplete,getVideoId,videoPaused,lastSec;playPoll={};lastNum={};videoPaused={};lastSec={};tag=document.createElement("script");tag.src="//www.youtube.com/player_api";firstScriptTag=document.getElementsByTagName("script")[0];
firstScriptTag.parentNode.insertBefore(tag,firstScriptTag);OFAlog=function(msg){_gaq.push(["_trackEvent",videoCategory,msg.action,msg.label,0,true]);ofa.debug.log("YT Logging: "+msg.label)};getVideoId=function(url){var queryString=url.split("?")[1],queryStringArgs=queryString.split("&"),numQueryArgs,pair,videoID,i;for(i=0,numQueryArgs=queryStringArgs.length;i<numQueryArgs;i++){pair=queryStringArgs[i].split("=");if(pair[0]==="v"){videoID=pair[1];ofa.debug.log("Video ID is: "+videoID);break}}return videoID};
onYouTubePlayerAPIReady=function(){var iframes=document.getElementsByTagName("iframe"),numIframes=iframes.length,videos=[],i,numVideos,player;ofa.debug.log("YouTube Player ready");for(i=0;i<numIframes;i++)if(iframes[i].src.indexOf("youtube.com")!==-1)videos.push(iframes[i]);numVideos=videos.length;ofa.debug.log(numVideos+" youtube videos on the page");for(i=0;i<numVideos;i++){ofa.debug.log("Video "+(i+1));player=new YT.Player(videos[i],{events:{"onReady":onPlayerReady,"onStateChange":onPlayerStateChange,
"onError":onPlayerError}});ofa.debug.log("Created new YT.Player");YTAnalytics.players[player.a.id]=player;lastNum[player.a.id]=0;lastSec[player.a.id]=0;videoPaused[player.a.id]=true;ofa.debug.log("YT.Player created for "+player.a.id)}};onPlayerStateChange=function(event){switch(event.data){case YT.PlayerState.PLAYING:pollPlayer(event);ofa.debug.log("Play event");break;case YT.PlayerState.PAUSED:pausePolling(event);ofa.debug.log("Pause event");break;case YT.PlayerState.ENDED:videoComplete(event);ofa.debug.log("End event");
break;default:break}};onPlayerReady=function(event){ofa.debug.log("ready")};onPlayerError=function(event){OFAlog({"label":"error","action":getVideoId(YTAnalytics.players[event.target.a.id].getVideoUrl())});ofa.debug.log("error")};pollPlayer=function(event){var curPlayTime;playPoll[event.target.a.id]=setInterval(function(){var curPlayTime=event.target.getCurrentTime(),time=Math.floor(curPlayTime);ofa.debug.log(time);if(videoPaused[event.target.a.id]){OFAlog({"label":"play","action":getVideoId(YTAnalytics.players[event.target.a.id].getVideoUrl())});
ofa.debug.log("play");ofa.debug.log(curPlayTime);videoPaused[event.target.a.id]=false}if(time%5===0&&lastNum[event.target.a.id]!==time){lastNum[event.target.a.id]=time;OFAlog({"label":"watched "+time+" seconds","action":getVideoId(YTAnalytics.players[event.target.a.id].getVideoUrl())});ofa.debug.log("watched "+time+" seconds");ofa.debug.log("case 1: "+curPlayTime)}else if(time-lastSec[event.target.a.id]>1&&(time-1)%5===0){lastNum[event.target.a.id]=time-1;OFAlog({"label":"watched "+(time-1)+" seconds",
"action":getVideoId(YTAnalytics.players[event.target.a.id].getVideoUrl())});ofa.debug.log("watched "+(time-1)+" seconds");ofa.debug.log("case 2: "+curPlayTime)}else if(time-lastSec[event.target.a.id]>1&&(time-1)%5===0){lastNum[event.target.a.id]=time;OFAlog({"label":"watched "+(time-1)+" seconds","action":getVideoId(YTAnalytics.players[event.target.a.id].getVideoUrl())});ofa.debug.log("watched "+(time-1)+" seconds");ofa.debug.log("case 3: "+curPlayTime)}lastSec[event.target.a.id]=time},1E3)};pausePolling=
function(event){var time;clearInterval(playPoll[event.target.a.id]);time=Math.floor(event.target.getCurrentTime());videoPaused[event.target.a.id]=true;ofa.debug.log("Polling paused")};videoComplete=function(event){OFAlog({"label":"end at "+Math.floor(YTAnalytics.players[event.target.a.id].getDuration())+" seconds","action":getVideoId(YTAnalytics.players[event.target.a.id].getVideoUrl()),"value":YTAnalytics.players[event.target.a.id].getDuration()});ofa.debug.log("end at "+Math.floor(YTAnalytics.players[event.target.a.id].getDuration())+
" seconds");pausePolling(event)};return{onYouTubePlayerAPIReady:onYouTubePlayerAPIReady}}();win.onYouTubePlayerAPIReady=YTAnalytics.trackvideo.onYouTubePlayerAPIReady})(window);
