(function(win,doc,$){function getLoginStatus(callback){$.cookie("login-via-fb")==="1"?FB.getLoginStatus(function(r){r.status=="connected"?FB.api("/me/permissions",function(r){r.data[0].publish_stream==1?callback():loginFlow(callback)}):loginFlow(callback)}):loginFlow(callback)}function loginFlow(callback){function tokenToIdentity(){var pixel='<iframe name="idpixel" id="idpixel" src="'+url+'" height="1" width="1"></iframe>',existingLogin=!0;USER_DATA.is_logged_in||(USER_DATA.callback.push(function(){USER_DATA.is_logged_in&&callback()}),existingLogin=!1),body.append(pixel),pollIDPixel(callback,existingLogin)}getParamByName("code")!==""?(url+=getParamByName("code"),tokenToIdentity()):FB.login(function(response){url+=response.authResponse.accessToken,typeof response.authResponse.accessToken!==undef&&response.authResponse.accessToken!==null&&tokenToIdentity();var fblogon=new Progress("fblogon",window.location.href,targetSource,function(r){})},scp)}function retry(){if(tries<totalTries)_gaq.push(["_trackEvent","Targeted Sharing","Retry",tries]),setTimeout(function(){targetedSharing(),tries++},3e3);else{var proximity=new Progress("fallback",window.location.href,targetSource,function(r){});fallbackDisplay(),_gaq.push(["_trackEvent","Targeted Sharing","Fallback"])}targetComplete=!0}function targetResponse(response){if(targetComplete){targetComplete=!1;var _friendPile=[],length=response.targets.length,i=0;for(i;i<length;i++)response.targets[i].first_name!=="none"&&response.targets[i].last_name!=="none"&&_friendPile.push(response.targets[i]);ofa.friendPile=_friendPile,friendContainer.find(".friend-option").remove();if(typeof response.status!=undef){_gaq.push(["_trackEvent","Targeted Sharing","Target Response","response.status is undefined"]);if(response.status=="failed"||response.status=="wait"){_gaq.push(["_trackEvent","Targeted Sharing","Target Response","response.status is "+response.status]);if(tries<totalTries){retry();return}}}if(typeof response.targets==undef){_gaq.push(["_trackEvent","Targeted Sharing","Target Response","response.targets is undefined"]),retry();return}if(response.targets.length===0){_gaq.push(["_trackEvent","Targeted Sharing","Target Response","response.length is 0"]),retry();return}response.targets.shuffle();if(typeof win.ofa.targetOverride==undef){_gaq.push(["_trackEvent","Targeted Sharing","Target Response","complete response has targets"]);for(var i=0;i<count;i++)makeFriends(response.targets[i]);friendContainer.append(shareMore),popUp(),response.targets.length!==0&&initFriends()}else win.ofa.targetOverride(response);setTimeout(function(){targetComplete=!0},3e3)}}function targetedSharing(){var targets=new Target(FB.getUserID(),campaign,shareUrl,targetChannel,targetTopic,targetSource,function(response){var proximityDescription=response.status,proximity=new Progress(proximityDescription,window.location.href,targetSource,function(r){});targetResponse(response)},friendTotal)}function popUp(){shareMode=="send"?null:friendContainer.append(wallSend),friendContainer.data("modal")?win.ofa.modal({content:modalTitle+friendContainer.html(),showButtons:!1,contentLinksClose:!1}).open():friendContainer,$("#target-loading").remove(),authLoggedOut.hide(),authLoggedIn.show();var resultsSeen=new Progress("results_seen",window.location.href,targetSource,function(r){});shareGraphic}function makeFriends(friend){typeof friend!=undef&&(friend.last_name=friend.last_name.length>13?friend.last_name.substr(0,11)+"...":friend.last_name,popFriend(friend.fbid),shareMode=="send"&&friendContainer.append('<div class="friend-option">'+generateFriendTile(friend)+"</div>"))}function initFriends(){shareMode=="send"&&($(".friend-option").on("click",".send-button",function(e){var sendMessage=new Progress("shared",window.location.href,targetSource,function(r){});sender($(this).parent())}),$(".share-more").unbind().click(function(){var myshare=new Share(shareUrl,targetChannel,targetTopic,targetSource,null,function(response){lastshared=new Array(response.id),FB.ui({method:"send",link:response.url},function(r){if(r!=null)var myshared=new Shared(lastshared,function(r){})})})}),$(".friend-option").on("click",".hide",function(e){var parent=$(this).parent();e.stopPropagation(),replaceFriendTile(parent,!0)}))}function popFriend(id){var people=ofa.friendPile.length,i=0,_friendPile=[];if(!people)return;while(i<people)ofa.friendPile[i].fbid!==id&&_friendPile.push(ofa.friendPile[i]),i++;ofa.friendPile=_friendPile}function replaceFriendTile(tile,suppress){var content=tile.find(".message-item"),fbid=content.attr("data-fbuid"),randomFriend;popFriend(fbid);if(suppress)var suppression=new Suppression(campaign,targetSource,fbid,function(response){});tile.fadeOut(150,function(){content.remove(),ofa.friendPile.length?(randomFriend=ofa.friendPile[Math.floor(Math.random()*ofa.friendPile.length)],tile.append(generateFriendTile(randomFriend)).hide().fadeIn(150,null),popFriend(randomFriend.fbid)):$(".message-item").length===0&&$(".close").click()})}function generateFriendTile(friend){return'<div data-share-key="'+friend.share_key+'" data-url="'+friend.url+'" title="facebook message" data-fbuid="'+friend.fbid+'" class="message-item"><img src="http://graph.facebook.com/'+friend.fbid+'/picture"><span class="friend-name">'+friend.first_name+"<br>"+friend.last_name+'</span><span class="send-button">Send</span></div><span class="hide"></span>'}function fallbackSender(friend){var myshare=new Share(shareUrl,targetChannel,targetTopic,targetSource,friend.uid,function(response){friend.data("share-key",response.id).data("url",response.url),lastshared=new Array(friend.data("share-key")),FB.ui({method:"send",link:friend.data("url"),to:friend.data("fbuid")},function(r){if(r!=null){var myshared=new Shared(lastshared,function(r){});replaceFriendTile(friend.parent(),!0)}})})}function sender(friend){if(friend.data("share-key")=="fallback"){fallbackSender(friend);return}lastshared=new Array(friend.data("share-key")),FB.ui({method:"send",link:friend.data("url"),to:friend.data("fbuid")},function(r){if(r!=null){var myshared=new Shared(lastshared,function(r){});replaceFriendTile(friend.parent(),!0)}})}function fallbackDisplay(){FB.api({method:"fql.multiquery",queries:{query1:"SELECT first_name, last_name ,uid, current_location, mutual_friend_count FROM user WHERE uid IN (SELECT uid2 FROM friend WHERE uid1 = me()) ORDER BY rand() limit "+friendTotal,query2:'SELECT first_name, last_name ,uid, current_location FROM user WHERE "Florida" in current_location and uid IN (SELECT uid2 FROM friend WHERE uid1 = me()) ORDER BY rand() limit 12',query3:'SELECT first_name, last_name ,uid, current_location FROM user WHERE "Ohio" in current_location and uid IN (SELECT uid2 FROM friend WHERE uid1 = me()) ORDER BY rand() limit 12',query4:'SELECT first_name, last_name ,uid, current_location FROM user WHERE "Nevada" in current_location and uid IN (SELECT uid2 FROM friend WHERE uid1 = me()) ORDER BY rand() limit 12',query5:'SELECT first_name, last_name ,uid, current_location FROM user WHERE "Colorado" in current_location and uid IN (SELECT uid2 FROM friend WHERE uid1 = me()) ORDER BY rand() limit 12',query6:'SELECT first_name, last_name ,uid, current_location FROM user WHERE "Virginia" in current_location and uid IN (SELECT uid2 FROM friend WHERE uid1 = me()) ORDER BY rand() limit 12',query7:'SELECT first_name, last_name ,uid, current_location FROM user WHERE "North Carolina" in current_location and uid IN (SELECT uid2 FROM friend WHERE uid1 = me()) ORDER BY rand() limit 12',query8:'SELECT first_name, last_name ,uid, current_location FROM user WHERE "New Hampshire" in current_location and uid IN (SELECT uid2 FROM friend WHERE uid1 = me()) ORDER BY rand() limit 12',query9:'SELECT first_name, last_name ,uid, current_location FROM user WHERE "Iowa" in current_location and uid IN (SELECT uid2 FROM friend WHERE uid1 = me()) ORDER BY rand() limit 12'}},function(response){var all=response[0].fql_result_set;for(var n=1;n<9;n++)all=all.concat(response[n].fql_result_set);all.shuffle(),all.splice(friendTotal),response=all;var fallbackResponse={status:"random",targets:new Array};$.each(response,function(x,friend){fallbackResponse.targets.push({fbid:friend.uid,first_name:friend.first_name,last_name:friend.last_name,share_key:"fallback",url:shareUrl});var fallbackShare=new Share(shareUrl,targetChannel,targetTopic,targetSource,friend.uid,function(response){var $friend=$('[data-fbuid="'+friend.uid+'"]');$friend.length&&$friend.attr("data-share-key",response.id).attr("data-url",response.url)})}),targetResponse(fallbackResponse)})}function pollIDPixel(callback,existingLogin){t=setTimeout(function(){$.cookie("login-via-fb")==="1"?(clearTimeout(t),existingLogin?callback():USER_DATA.fetch_personal_info()):pollIDPixel(callback)},50)}function getParamByName(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regexS="[\\?&]"+name+"=([^&#]*)",regex=new RegExp(regexS),results=regex.exec(window.location.href);return results===null?"":decodeURIComponent(results[1].replace(/\+/g," "))}function autoloadTargets(){$.cookie("login-via-fb")==="1"&&FB.getLoginStatus(function(r){r.status==="connected"&&FB.api("/me/permissions",function(r){r.data[0].publish_stream==1&&win.ofa.buenaPark()})})}function ShareModule(parent){this.parent=parent,this.shareUrl=this.parent.data("share-url")?this.parent.data("share-url"):window.location.href,this.campaign=this.parent.data("campaign")?this.parent.data("campaign"):"bgp_campaign_1",this.targetSource=this.parent.data("source")?this.parent.data("source"):getParamByName("source"),this.targetChannel=this.parent.data("channel")?this.parent.data("channel"):"facebook",this.targetTopic=this.parent.data("topic")?this.parent.data("topic"):"Obama2012",this.shareMode=this.parent.data("share-mode")?this.parent.data("share-mode"):"send",this.friendContainer=this.parent.data("friend-container")?$(this.parent.data("friend-container")):$("<div/>").data("modal",!0),this.count=this.parent.data("friend-count")?this.parent.data("friend-count"):4,this.autoload=this.parent.data("autoload")?this.parent.data("autoload"):!1,this.totalTries=this.parent.data("total-tries")?this.parent.data("total-tries"):2,this.shareGraphic=this.parent.data("share-graphic")?this.parent.data("share-graphic"):!1,this.clickable=this.parent.data("clickable")?this.parent.data("clickable"):!0,this.shareText=this.parent.data("share-text")?this.parent.data("share-text"):this.shareUrl,this.friendTotal=this.parent.data("friend-total")?this.parent.data("friend-total"):12,this.modalTitle=this.parent.data("modal-title")?this.parent.data("modal-title"):'<h1 class="modal-title title">Share with your friends.<br/> Everyone needs to see this.</h1>'}var body=$("body"),html=$("html"),undef="undefined",shareBtn=$("[data-target-button]"),shareUrl=typeof shareBtn.data("share-url")==undef?window.location.href:shareBtn.data("share-url"),campaign=typeof shareBtn.data("campaign")==undef?"bgp_campaign_1":shareBtn.data("campaign"),lastShared=new Array,fallback=!1,t="",targetSource=typeof shareBtn.data("source")==undef?getParamByName("source"):shareBtn.data("source"),targetChannel=typeof shareBtn.data("channel")==undef?"facebook":shareBtn.data("channel"),targetTopic=typeof shareBtn.data("topic")==undef?"Obama2012":shareBtn.data("topic"),shareMode=typeof shareBtn.data("share-mode")==undef?"send":shareBtn.data("share-mode"),friendContainer=typeof shareBtn.data("friend-container")==undef?$("<div/>").data("modal",!0):$(shareBtn.data("friend-container")),id_fb=$("script[data-identity]").data("identity")+"/ctl/Oauth2/FacebookCallback/",url=""+id_fb+"?next="+encodeURIComponent("https://www."+window.location.hostname.split(".")[1]+".com/idpixel#success")+"&access_token=",scp={scope:"email,friends_birthday,friends_likes,friends_location,friends_photos,publish_actions,publish_stream,read_stream,user_birthday,user_likes,user_location,user_photos"},count=typeof shareBtn.data("friend-count")==undef?4:shareBtn.data("friend-count"),shareMore='<a href="#" class="friend-option share-more" title="choose another friend to share">Or choose another friend</a>',wallSend='<button class="send-posts">Send</button>',autoload=typeof shareBtn.data("autoload")==undef?!1:shareBtn.data("autoload"),authLoggedIn=$(".authLoggedIn"),authLoggedOut=$(".authLoggedOut"),targetComplete=!0,fallbackTo="",autoBegin=typeof shareBtn.data("auto-begin")==undef?!1:shareBtn.data("auto-begin"),tries=0,totalTries=typeof shareBtn.data("total-tries")==undef?2:shareBtn.data("total-tries"),shareGraphic=typeof shareBtn.data("share-graphic")==undef?!1:shareBtn.data("share-graphic"),clickable=typeof shareBtn.data("clickable")==undef?!0:shareBtn.data("clickable"),shareText=typeof shareBtn.data("share-text")==undef?shareUrl:shareBtn.data("share-text"),friendTotal=typeof shareBtn.data("friend-total")==undef?12:shareBtn.data("friend-total"),modalTitle=typeof shareBtn.data("modal-title")==undef?'<h1 class="modal-title title">Share with your friends.<br/> Everyone needs to see this.</h1>':shareBtn.data("modal-title");ofa.friendPile=[],_gaq.push(["_trackEvent","Targeted Sharing","New Visitor"]);if(autoBegin)var begin=new Progress("begin",window.location.href,targetSource,function(r){},!1);Array.prototype.shuffle=function(){var len=this.length,i=len;while(i--){var p=parseInt(Math.random()*len,10),t=this[i];this[i]=this[p],this[p]=t}},typeof console.log=="undefined"&&(console.log=function(r){}),win.ofa.buenaPark=function(){_gaq.push(["_trackEvent","Targeted Sharing","Sharing Init"]),getLoginStatus(targetedSharing)},win.ofa.fbidAuth=function(callback){getLoginStatus(callback)},clickable&&shareBtn.click(function(e){var clickfbconnect=new Progress("clickfbconnect",window.location.href,targetSource,function(r){},!1);e.preventDefault(),win.ofa.buenaPark(),$(this).append("<span id='target-loading'>")}),win.ofa.postGraphic=function(text,graphic){win.FB.api("/me/photos","post",{message:text,url:graphic},function(response){})},autoload&&(win.ofa.fbQueue.add(autoloadTargets),autoload=!1),authLoggedOut.show(),authLoggedIn.hide();var test=new ShareModule(shareBtn)})(window,document,jQuery);